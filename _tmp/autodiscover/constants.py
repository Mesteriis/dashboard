from __future__ import annotations

import re
from pathlib import Path

DEFAULT_PORT_SCAN_MAX = 65_535
DEFAULT_MAX_PARALLEL = 128
DEFAULT_MAX_HOSTS = 512
DEFAULT_CONNECT_TIMEOUT_SEC = 0.25
DEFAULT_PORTS_RANGE = (1, 20_000)
DEFAULT_RESULT_FILE = Path("data") / "autodiscover_result.json"

PORT_SERVICE_NAMES: dict[int, str] = {
    21: "ftp",
    22: "ssh",
    23: "telnet",
    25: "smtp",
    53: "dns",
    67: "dhcp-server",
    68: "dhcp-client",
    80: "http",
    81: "http-alt",
    88: "kerberos",
    110: "pop3",
    111: "rpcbind",
    123: "ntp",
    135: "rpc",
    137: "netbios-ns",
    138: "netbios-dgm",
    139: "netbios",
    143: "imap",
    161: "snmp",
    389: "ldap",
    443: "https",
    445: "smb",
    465: "smtps",
    500: "isakmp",
    514: "syslog",
    515: "lpd",
    587: "submission",
    631: "ipp",
    873: "rsync",
    993: "imaps",
    995: "pop3s",
    1080: "socks",
    1433: "mssql",
    1521: "oracle",
    1723: "pptp",
    1883: "mqtt",
    2049: "nfs",
    2375: "docker",
    2376: "docker-tls",
    25565: "minecraft",
    3000: "app-3000",
    3001: "app-3001",
    3002: "app-3002",
    3128: "proxy",
    3306: "mysql",
    3389: "rdp",
    5000: "app-5000",
    5001: "app-5001",
    5432: "postgres",
    5601: "kibana",
    5672: "amqp",
    5900: "vnc",
    5985: "winrm",
    5986: "winrm-tls",
    6379: "redis",
    6443: "k8s-api",
    7001: "weblogic",
    7002: "weblogic-ssl",
    7199: "cassandra-jmx",
    7443: "https-alt",
    7575: "homarr",
    7878: "radarr",
    8000: "app-8000",
    8006: "proxmox",
    8080: "http-alt",
    8081: "http-alt",
    8086: "influxdb",
    8096: "jellyfin",
    8123: "home-assistant",
    8191: "flaresolverr",
    8265: "tdarr",
    8266: "tdarr-node",
    8443: "https-alt",
    8686: "lidarr",
    8787: "readarr",
    8989: "sonarr",
    9000: "portainer",
    9042: "cassandra",
    9090: "prometheus",
    9091: "prometheus-pushgateway",
    9100: "node-exporter",
    9696: "prowlarr",
    10000: "webmin",
    11434: "ollama",
    13378: "audiobookshelf",
    19999: "netdata",
    6333: "qdrant",
    9200: "elasticsearch",
    9300: "elasticsearch-transport",
    9443: "https-alt",
}

SAFE_DEFAULT_SCAN_PORTS = tuple(sorted(PORT_SERVICE_NAMES))
DEFAULT_SCAN_PORTS = tuple(range(DEFAULT_PORTS_RANGE[0], DEFAULT_PORTS_RANGE[1] + 1))

NON_HTTP_PROTOCOL_PORTS = {
    21,
    22,
    23,
    25,
    53,
    67,
    68,
    88,
    110,
    111,
    123,
    135,
    137,
    138,
    139,
    143,
    161,
    389,
    445,
    465,
    500,
    514,
    515,
    587,
    631,
    873,
    993,
    995,
    1433,
    1521,
    1723,
    1883,
    2049,
    2375,
    2376,
    3306,
    3389,
    5432,
    5672,
    5900,
    5985,
    5986,
    6379,
    7199,
    9042,
}

HTTPS_HINT_PORTS = {443, 2376, 5986, 7002, 7443, 8443, 9443}
HTTP_EXPECTED_PORTS = {
    80,
    81,
    443,
    3000,
    3001,
    3002,
    3128,
    5000,
    5001,
    5601,
    7001,
    7002,
    7443,
    7575,
    7878,
    8000,
    8080,
    8081,
    8086,
    8096,
    8123,
    8191,
    8265,
    8266,
    8443,
    8686,
    8787,
    8989,
    9000,
    9090,
    9091,
    9696,
    11434,
    13378,
    19999,
    6333,
    9200,
    9300,
    9443,
    10000,
}

IMPORTANT_EVENT_PORTS = {
    22,
    445,
    2375,
    3306,
    3389,
    5432,
    5900,
    5985,
    5986,
    6379,
    6443,
    9200,
}

TITLE_RE = re.compile(r"<title[^>]*>(.*?)</title>", re.IGNORECASE | re.DOTALL)
DESCRIPTION_RE = re.compile(
    r'<meta[^>]+name=["\']description["\'][^>]+content=["\'](.*?)["\']',
    re.IGNORECASE | re.DOTALL,
)
DESCRIPTION_RE_ALT = re.compile(
    r'<meta[^>]+content=["\'](.*?)["\'][^>]+name=["\']description["\']',
    re.IGNORECASE | re.DOTALL,
)

_IP_ADDR_INET_RE = re.compile(r"\binet\s+(?P<addr>\d+\.\d+\.\d+\.\d+/\d{1,2})\b")
_IFCONFIG_INET_RE = re.compile(
    r"\binet\s+(?P<ip>\d+\.\d+\.\d+\.\d+)(?:\s+netmask\s+(?P<mask>0x[0-9A-Fa-f]{8}|\d+\.\d+\.\d+\.\d+))?"
)

MAC_OUI_VENDORS = {
    "BC2411": "Proxmox Server Solutions GmbH",
    "000C29": "VMware",
    "000569": "VMware",
    "005056": "VMware",
    "0003FF": "Microsoft Hyper-V",
    "00155D": "Microsoft Hyper-V",
    "080027": "Oracle VirtualBox",
    "525400": "QEMU/KVM",
    "0242AC": "Docker",
    "B827EB": "Raspberry Pi Foundation",
    "DCA632": "Raspberry Pi Trading",
    "E45F01": "Raspberry Pi Trading",
    "F4F26D": "Ubiquiti",
    "24A43C": "Ubiquiti",
    "FCECDA": "Ubiquiti",
    "D850E6": "TP-Link",
    "AC84C6": "TP-Link",
    "E894F6": "TP-Link",
    "8C3B4A": "MikroTik",
    "4C5E0C": "MikroTik",
    "FC3497": "Asus",
    "F07959": "Asus",
    "F8FFCF": "Apple",
    "3C22FB": "Apple",
    "A4C361": "Apple",
    "D8BB2C": "Apple",
    "3CD92B": "Hewlett Packard",
    "0025B3": "Dell",
    "F8B156": "Dell",
    "F4CE46": "Intel",
    "A44CC8": "Intel",
    "001A8C": "Cisco",
    "58D56E": "Huawei",
    "94D9B3": "Xiaomi",
}


__all__ = [
    "DEFAULT_CONNECT_TIMEOUT_SEC",
    "DEFAULT_MAX_HOSTS",
    "DEFAULT_MAX_PARALLEL",
    "DEFAULT_PORTS_RANGE",
    "DEFAULT_PORT_SCAN_MAX",
    "DEFAULT_RESULT_FILE",
    "DEFAULT_SCAN_PORTS",
    "DESCRIPTION_RE",
    "DESCRIPTION_RE_ALT",
    "HTTPS_HINT_PORTS",
    "HTTP_EXPECTED_PORTS",
    "IMPORTANT_EVENT_PORTS",
    "MAC_OUI_VENDORS",
    "NON_HTTP_PROTOCOL_PORTS",
    "PORT_SERVICE_NAMES",
    "SAFE_DEFAULT_SCAN_PORTS",
    "TITLE_RE",
    "_IFCONFIG_INET_RE",
    "_IP_ADDR_INET_RE",
]
